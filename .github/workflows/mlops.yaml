name: MLOps

on:
  push:
    branches:
      - dev

jobs:
  train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Activer le compte de service avec le fichier service-account-key.json
      - name: Activate Service Account
        run: |
          gcloud auth activate-service-account --key-file="service-account-key.json"

      - name: List files in context
        run: ls -la

      # Configurer le projet GCP
      - name: Configure gcloud
        run: gcloud config set project modern-bond-303506

      # Vérifier les permissions sur le bucket
      - name: Check GCS Bucket Access
        run: |
          echo "Testing GCS access..."
          gsutil ls gs://sportify_classifier || echo "Bucket access failed, ensure credentials and permissions are correct"

      # Construire l'image Docker et la pousser sur GCR
      - name: Build and push Docker image
        run: |
          echo "Building Docker image and pushing to GCR..."
          gcloud builds submit --tag gcr.io/modern-bond-303506/train_image:latest


      # Lancer le job Vertex AI
      - name: Launch Vertex AI job
        id: launch_job
        run: |
          echo "Launching Vertex AI Job..."
          JOB_ID=$(gcloud ai custom-jobs create \
          --region=us-central1 \
          --display-name="entraînement-mlops" \
          --worker-pool-spec=machine-type=n1-standard-4,container-image-uri=gcr.io/modern-bond-303506/train_image:latest \
          --service-account=sportify-classier@modern-bond-303506.iam.gserviceaccount.com \
          --args="--output-dir=gs://sportify_classifier/evaluation_output" \
          --format='value(name)')
          echo "Vertex AI Job ID: $JOB_ID"
          echo "JOB_ID=$JOB_ID" >> $GITHUB_ENV

      # Attendre la fin du job Vertex AI
      - name: Wait for job to finish
        run: |
          echo "Waiting for Vertex AI Job to finish..."
          STATUS=$(gcloud ai custom-jobs describe "${JOB_ID}" --region=us-central1 --format='value(state)')
          MAX_RETRIES=60 
          COUNT=0
          while [ "$STATUS" != "JOB_STATE_SUCCEEDED" ] && [ "$STATUS" != "JOB_STATE_FAILED" ] && [ $COUNT -lt $MAX_RETRIES ]; do
            echo "Job status: $STATUS"
            echo "Fetching logs for Job ID: ${JOB_ID}..."
            gcloud logging read "resource.type=ml_job AND resource.labels.job_id=\"${JOB_ID}\"" --limit=50 --format="value(textPayload)"
            sleep 30
            STATUS=$(gcloud ai custom-jobs describe "${JOB_ID}" --region=us-central1 --format='value(state)')
            COUNT=$((COUNT + 1))
          done

          echo "Final job status: $STATUS"
          if [ "$STATUS" = "JOB_STATE_FAILED" ]; then
            echo "Fetching detailed logs for failure..."
            gcloud logging read "resource.type=ml_job AND resource.labels.job_id=\"${JOB_ID}\"" --limit=100 --format="value(textPayload)"
            exit 1
          elif [ $COUNT -ge $MAX_RETRIES ]; then
            echo "Job did not finish within the expected time."
            exit 1
          fi
        env:
          JOB_ID: ${{ env.JOB_ID }}

      # Récupérer les résultats depuis GCS
      - name: Pull evaluation_output from GCS
        run: |
          echo "Ensuring local evaluation_output directory exists..."
          mkdir -p ./evaluation_output
          echo "Fetching evaluation_output from GCS..."
          gsutil -m cp -r "gs://sportify_classifier/evaluation_output/*" ./evaluation_output
          echo "Listing downloaded files..."
          ls -la ./evaluation_output

      # Générer un rapport CML
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup CML
        uses: iterative/setup-cml@v2
        with:
          version: '0.20.0'
      - name: Create CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Evaluation Report" > report.md
          echo "## Metrics" >> report.md
          cat ./evaluation_output/metrics.json | jq . >> report.md

          echo "## Plots" >> report.md
          echo "### Loss Curve" >> report.md
          echo '![](./evaluation_output/loss_curve.png)' >> report.md
          echo "### Confusion Matrix" >> report.md
          echo '![](./evaluation_output/confusion_matrix.png)' >> report.md
          echo "### Normalized Confusion Matrix" >> report.md
          echo '![](./evaluation_output/normalized_confusion_matrix.png)' >> report.md
          echo "### Precision-Recall Curves" >> report.md
          echo '![](./evaluation_output/precision_recall_curves.png)' >> report.md

      # Créer une Pull Request pour fusionner `dev` dans `main`
      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automated results from dev branch"
          branch: dev
          base: main
          title: "Merge dev into main with evaluation results"
          body: |
            This PR contains the latest evaluation results and plots:
            - Metrics
            - Loss Curve
            - Confusion Matrix
            - Precision-Recall Curves
            Review the evaluation results in the attached report.
          draft: false # Set to true if you want to create the PR as a draft